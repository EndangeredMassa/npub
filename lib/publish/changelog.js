// Generated by CoffeeScript 2.0.0-beta7
void function () {
  var debug, fs, mkdirp, repeat, touch;
  fs = require('fs');
  mkdirp = require('mkdirp');
  touch = require('touch');
  debug = require('debug')('changelog');
  repeat = function (pattern, count) {
    var str;
    str = '';
    while (count > 0) {
      str += pattern;
      count--;
    }
    return str;
  };
  module.exports = function (dir, git) {
    var changelogPath;
    changelogPath = '' + dir + '/CHANGELOG.md';
    return {
      build: function (version, callback) {
        var currentChangelog;
        debug('build');
        currentChangelog = fs.readFileSync(changelogPath);
        return git.diffSinceLastTag(function (err, commits) {
          var completeDiff;
          if (null != err)
            return callback(err, commits);
          completeDiff = [
            version,
            repeat('-', version.length),
            commits,
            currentChangelog
          ].join('\n');
          debug('prepend addition');
          return callback(null, completeDiff);
        });
      },
      write: function (changelog, filePath) {
        if (null == filePath)
          filePath = '/tmp/npub/changelog.md';
        mkdirp.sync('/tmp/npub');
        fs.writeFileSync(filePath, changelog, { flag: 'w' });
        debug('wrote ' + filePath);
        return filePath;
      },
      update: function (filePath) {
        var newChangelog;
        debug('update from ' + filePath);
        touch.sync(changelogPath);
        newChangelog = fs.readFileSync(filePath);
        return this.write(newChangelog, changelogPath);
      }
    };
  };
}.call(this);
