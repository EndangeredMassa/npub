// Generated by CoffeeScript 2.0.0-beta7
void function () {
  var changelog, commitChanges, debug, endIf, ensureCleanStage, fs, git, license, npm, openEditor, prompt, updateVersion;
  fs = require('fs');
  license = require('./license');
  ensureCleanStage = require('./clean-stage');
  changelog = require('./changelog');
  openEditor = require('./editor');
  updateVersion = require('./version');
  commitChanges = require('./commit-changes');
  npm = require('./npm');
  git = require('./git');
  prompt = require('./prompt');
  endIf = function (exitCodeOrError, message) {
    if (!(null != exitCodeOrError))
      return;
    if (exitCodeOrError instanceof Error) {
      console.error('[npub] ' + exitCodeOrError.message);
      return process.exit(1);
    } else {
      if (exitCodeOrError === 0)
        return;
      if (null != message)
        message;
      else
        message = 'exited with ' + exitCodeOrError;
      console.error('[npub] ' + message);
      return process.exit(exitCodeOrError);
    }
  };
  debug = function (message) {
  };
  module.exports = function (dir, version, config) {
    return ensureCleanStage(dir, function (error) {
      endIf(error);
      license(dir, config);
      debug('ensured license headers');
      return ensureCleanStage(dir, function (error) {
        endIf(error);
        return npm.test(dir, function (error) {
          endIf(error);
          debug('ran: npm test');
          return changelog.build(dir, function (error, tempChangelog) {
            var tempChangelogPath;
            endIf(error);
            tempChangelogPath = changelog.write(dir, tempChangelog);
            debug('temp changelog at: ' + tempChangelogPath);
            return openEditor(tempChangelogPath, function (error) {
              if (null != error) {
                fs.unlinkSync(tempChangelogPath);
                endIf(error);
              }
              changelog.update(dir, tempChangelogPath);
              debug('updated changelog');
              updateVersion(dir, version);
              debug('updated version');
              return commitChanges(dir, version, function () {
                var tag;
                debug('changes committed');
                tag = 'v' + version;
                return git.tag(dir, tag, function (error) {
                  endIf(error);
                  debug('tagged: ' + tag);
                  return prompt(version, function (error) {
                    endIf(error);
                    return git.push(dir, function (error) {
                      endIf(error);
                      debug('git pushed');
                      return git.pushTag(dir, tag, function (error) {
                        endIf(error);
                        debug('git tag "' + tag + '" pushed');
                        return npm.publish(dir, function (error) {
                          endIf(error);
                          debug('published');
                          return console.log('success!');
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  };
}.call(this);
